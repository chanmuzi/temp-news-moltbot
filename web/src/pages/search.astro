---
import Layout from '../layouts/Layout.astro';
import ItemCard from '../components/ItemCard.astro';
import itemsData from '../../../data/items.json';

// Get all unique organizations
const orgs = [...new Set(itemsData.items.map(i => i.org))].sort();

// Get all items sorted
const allItems = [...itemsData.items].sort((a, b) => {
  const parseDate = (d: string) => {
    const parts = d.split('-');
    const year = parseInt(parts[0]) || 0;
    const month = parseInt(parts[1]) || 0;
    const week = parseInt(parts[2]?.replace('W', '')) || 0;
    return year * 10000 + month * 100 + week;
  };
  return parseDate(b.date) - parseDate(a.date);
});

// Get unique years
const years = [...new Set(itemsData.items.map(i => i.year))].sort().reverse();

// Stats
const stats = itemsData.stats || {};
---

<Layout title="ê²€ìƒ‰ - NLP Paper News">
  <!-- Header -->
  <section class="mb-8">
    <div class="flex items-center gap-4 mb-4">
      <a href={import.meta.env.BASE_URL} class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 transition-colors">
        â† í™ˆ
      </a>
    </div>
    <h1 class="text-3xl font-bold mb-2">ğŸ” ìƒì„¸ ê²€ìƒ‰</h1>
    <p class="text-gray-600 dark:text-gray-400">
      ì´ <span class="font-bold text-indigo-600">{itemsData.total_items.toLocaleString()}</span>ê°œ í•­ëª©ì—ì„œ ê²€ìƒ‰
    </p>
  </section>

  <!-- Search Filters -->
  <section class="bg-white dark:bg-gray-900 rounded-2xl border-2 border-gray-200 dark:border-gray-800 p-6 mb-8 shadow-sm">
    <div class="grid gap-4 md:grid-cols-2 lg:grid-cols-4">
      <div>
        <label class="block text-sm font-semibold mb-2 text-gray-700 dark:text-gray-300">ğŸ”¤ í‚¤ì›Œë“œ</label>
        <input
          type="text"
          id="keyword-input"
          placeholder="ê²€ìƒ‰ì–´ ì…ë ¥..."
          class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 focus:border-indigo-500 dark:focus:border-indigo-400 outline-none transition-all"
        />
      </div>
      
      <div>
        <label class="block text-sm font-semibold mb-2 text-gray-700 dark:text-gray-300">ğŸ“‚ íƒ€ì…</label>
        <select id="type-select" class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 focus:border-indigo-500 outline-none transition-all">
          <option value="">ì „ì²´</option>
          <option value="paper">ğŸ“œ Paper ({stats.paper || 0})</option>
          <option value="dev">ğŸ§‘ğŸ»â€ğŸ’» Dev ({stats.dev || 0})</option>
          <option value="news">ğŸ—ï¸ News ({stats.news || 0})</option>
        </select>
      </div>
      
      <div>
        <label class="block text-sm font-semibold mb-2 text-gray-700 dark:text-gray-300">ğŸ“… ì—°ë„</label>
        <select id="year-select" class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 focus:border-indigo-500 outline-none transition-all">
          <option value="">ì „ì²´</option>
          {years.map((year) => (
            <option value={year}>{year}ë…„</option>
          ))}
        </select>
      </div>
      
      <div>
        <label class="block text-sm font-semibold mb-2 text-gray-700 dark:text-gray-300">ğŸ¢ ê¸°ê´€</label>
        <select id="org-select" class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 focus:border-indigo-500 outline-none transition-all">
          <option value="">ì „ì²´</option>
          {orgs.slice(0, 150).map((org) => (
            <option value={org.toLowerCase()}>{org}</option>
          ))}
        </select>
      </div>
    </div>
    
    <div class="mt-6 flex flex-wrap gap-3">
      <button id="search-btn" class="px-6 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-xl font-bold hover:shadow-lg hover:shadow-indigo-500/25 transition-all">
        ğŸ” ê²€ìƒ‰
      </button>
      <button id="reset-btn" class="px-6 py-3 bg-gray-100 dark:bg-gray-800 rounded-xl font-medium hover:bg-gray-200 dark:hover:bg-gray-700 transition-all">
        â†º ì´ˆê¸°í™”
      </button>
    </div>
  </section>

  <!-- Results -->
  <section>
    <div class="flex items-center justify-between mb-6">
      <h2 class="text-xl font-bold">ê²€ìƒ‰ ê²°ê³¼</h2>
      <div class="flex items-center gap-3">
        <span id="result-count" class="text-gray-500 bg-gray-100 dark:bg-gray-800 px-3 py-1 rounded-full text-sm">
          {allItems.length}ê°œ
        </span>
      </div>
    </div>
    
    <div id="results-grid" class="grid gap-4 md:grid-cols-2">
      {allItems.slice(0, 50).map((item) => (
        <div 
          class="search-item" 
          data-type={item.type} 
          data-year={item.year} 
          data-org={item.org.toLowerCase()} 
          data-text={`${item.title} ${item.org} ${item.bullets.map(b => b.text).join(' ')}`.toLowerCase()}
        >
          <ItemCard {...item} showWeek={true} />
        </div>
      ))}
    </div>
    
    <!-- Load more -->
    <div id="load-more-container" class="text-center mt-8">
      <button id="load-more-btn" class="px-8 py-3 bg-gray-100 dark:bg-gray-800 rounded-xl font-medium hover:bg-gray-200 dark:hover:bg-gray-700 transition-all">
        ë” ë³´ê¸° ({Math.max(0, allItems.length - 50)}ê°œ ë”)
      </button>
    </div>
    
    <div id="no-results" class="hidden text-center py-16">
      <p class="text-6xl mb-4">ğŸ”</p>
      <p class="text-xl text-gray-500 dark:text-gray-400">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</p>
      <p class="text-sm text-gray-400 dark:text-gray-500 mt-2">ë‹¤ë¥¸ í‚¤ì›Œë“œë¡œ ê²€ìƒ‰í•´ë³´ì„¸ìš”</p>
    </div>
  </section>
</Layout>

<script>
  const keywordInput = document.getElementById('keyword-input') as HTMLInputElement;
  const typeSelect = document.getElementById('type-select') as HTMLSelectElement;
  const yearSelect = document.getElementById('year-select') as HTMLSelectElement;
  const orgSelect = document.getElementById('org-select') as HTMLSelectElement;
  const searchBtn = document.getElementById('search-btn');
  const resetBtn = document.getElementById('reset-btn');
  const resultCount = document.getElementById('result-count');
  const noResults = document.getElementById('no-results');
  const resultsGrid = document.getElementById('results-grid');
  const loadMoreBtn = document.getElementById('load-more-btn');
  const loadMoreContainer = document.getElementById('load-more-container');
  const items = document.querySelectorAll('.search-item');
  
  let shownCount = 50;
  
  function search() {
    const keyword = keywordInput.value.toLowerCase().trim();
    const type = typeSelect.value;
    const year = yearSelect.value;
    const org = orgSelect.value;
    
    let visibleCount = 0;
    
    items.forEach((item, index) => {
      const el = item as HTMLElement;
      const itemType = el.getAttribute('data-type') || '';
      const itemYear = el.getAttribute('data-year') || '';
      const itemOrg = el.getAttribute('data-org') || '';
      const itemText = el.getAttribute('data-text') || '';
      
      const matchKeyword = !keyword || itemText.includes(keyword);
      const matchType = !type || itemType === type;
      const matchYear = !year || itemYear === year;
      const matchOrg = !org || itemOrg.includes(org);
      
      const matchesFilter = matchKeyword && matchType && matchYear && matchOrg;
      
      // Show based on filter AND pagination
      const show = matchesFilter && (keyword || visibleCount < shownCount);
      el.style.display = show ? '' : 'none';
      if (matchesFilter) visibleCount++;
    });
    
    resultCount!.textContent = `${visibleCount}ê°œ`;
    noResults!.classList.toggle('hidden', visibleCount > 0);
    resultsGrid!.classList.toggle('hidden', visibleCount === 0);
    
    // Update load more button
    const remaining = visibleCount - shownCount;
    if (remaining > 0 && !keyword) {
      loadMoreContainer!.classList.remove('hidden');
      loadMoreBtn!.textContent = `ë” ë³´ê¸° (${remaining}ê°œ ë”)`;
    } else {
      loadMoreContainer!.classList.add('hidden');
    }
  }
  
  searchBtn?.addEventListener('click', search);
  keywordInput?.addEventListener('keyup', (e) => {
    if (e.key === 'Enter') search();
  });
  
  // Real-time filter on select change
  [typeSelect, yearSelect, orgSelect].forEach((el) => {
    el?.addEventListener('change', search);
  });
  
  // Load more
  loadMoreBtn?.addEventListener('click', () => {
    shownCount += 50;
    search();
  });
  
  resetBtn?.addEventListener('click', () => {
    keywordInput.value = '';
    typeSelect.value = '';
    yearSelect.value = '';
    orgSelect.value = '';
    shownCount = 50;
    search();
  });
  
  // Initial load
  search();
</script>
