---
import Layout from '../layouts/Layout.astro';
import ItemCard from '../components/ItemCard.astro';
import itemsData from '../../../data/items.json';

// Sort items by date (newest first)
const sortedItems = [...itemsData.items].sort((a, b) => {
  const parseDate = (d: string) => {
    const parts = d.split('-');
    const year = parseInt(parts[0]) || 0;
    const month = parseInt(parts[1]) || 0;
    const week = parseInt(parts[2]?.replace('W', '')) || 0;
    return year * 10000 + month * 100 + week;
  };
  return parseDate(b.date) - parseDate(a.date);
});

// Get latest 2 weeks of items
const latestDate = sortedItems[0]?.date || '';
const latestParts = latestDate.split('-');
const latestYear = parseInt(latestParts[0]) || 2026;
const latestMonth = parseInt(latestParts[1]) || 1;
const latestWeek = parseInt(latestParts[2]?.replace('W', '')) || 1;

// Calculate 2 weeks back
const getWeeksBack = (year: number, month: number, week: number, weeksBack: number) => {
  let w = week - weeksBack;
  let m = month;
  let y = year;
  while (w < 1) {
    m--;
    if (m < 1) { m = 12; y--; }
    w += 4;
  }
  return { year: y, month: m, week: Math.max(1, w) };
};

const twoWeeksBack = getWeeksBack(latestYear, latestMonth, latestWeek, 2);
const cutoffValue = twoWeeksBack.year * 10000 + twoWeeksBack.month * 100 + twoWeeksBack.week;

const latestItems = sortedItems.filter(item => {
  const parts = item.date.split('-');
  const y = parseInt(parts[0]) || 0;
  const m = parseInt(parts[1]) || 0;
  const w = parseInt(parts[2]?.replace('W', '')) || 0;
  return y * 10000 + m * 100 + w >= cutoffValue;
});

// Pagination settings
const ITEMS_PER_PAGE = 20;
const totalPages = Math.ceil(sortedItems.length / ITEMS_PER_PAGE);

// Group items by year-month for display
const grouped = sortedItems.reduce((acc, item) => {
  const key = `${item.year}-${item.month}`;
  if (!acc[key]) {
    acc[key] = { year: item.year, month: item.month, items: [] };
  }
  acc[key].items.push(item);
  return acc;
}, {} as Record<string, { year: string; month: string; items: typeof sortedItems }>);

const groups = Object.values(grouped).sort((a, b) => {
  const aVal = parseInt(a.year) * 100 + parseInt(a.month);
  const bVal = parseInt(b.year) * 100 + parseInt(b.month);
  return bVal - aVal;
});

// Stats
const stats = itemsData.stats || {
  paper: sortedItems.filter(i => i.type === 'paper').length,
  dev: sortedItems.filter(i => i.type === 'dev').length,
  news: sortedItems.filter(i => i.type === 'news').length,
};

const monthNames: Record<string, string> = {
  '1': '1ì›”', '2': '2ì›”', '3': '3ì›”', '4': '4ì›”',
  '5': '5ì›”', '6': '6ì›”', '7': '7ì›”', '8': '8ì›”',
  '9': '9ì›”', '10': '10ì›”', '11': '11ì›”', '12': '12ì›”',
};
---

<Layout title="NLP Paper News - AI ë…¼ë¬¸ & ë‰´ìŠ¤ íë ˆì´ì…˜">
  <!-- Hero Section -->
  <section class="relative overflow-hidden rounded-3xl bg-gradient-to-br from-indigo-600 via-purple-600 to-pink-500 p-8 md:p-12 mb-10 text-white">
    <div class="absolute inset-0 bg-[url('data:image/svg+xml,%3Csvg width=\"30\" height=\"30\" viewBox=\"0 0 30 30\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\"%3E%3Cpath d=\"M1.22676 0C1.91374 0 2.45351 0.539773 2.45351 1.22676C2.45351 1.91374 1.91374 2.45351 1.22676 2.45351C0.539773 2.45351 0 1.91374 0 1.22676C0 0.539773 0.539773 0 1.22676 0Z\" fill=\"rgba(255,255,255,0.07)\"%3E%3C/path%3E%3C/svg%3E')] opacity-50"></div>
    <div class="relative">
      <h1 class="text-4xl md:text-5xl font-black mb-3">
        ğŸ“š NLP Paper News
      </h1>
      <p class="text-lg md:text-xl text-white/80 mb-8 max-w-2xl">
        AI, NLP, ML ë¶„ì•¼ì˜ ìµœì‹  ë…¼ë¬¸ê³¼ ë‰´ìŠ¤ë¥¼ í•œëˆˆì—. ë§¤ì£¼ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤.
      </p>
      
      <!-- Stats Cards -->
      <div class="flex flex-wrap gap-4">
        <div class="bg-white/15 backdrop-blur-sm rounded-2xl px-6 py-4 border border-white/20">
          <div class="text-3xl font-black">{itemsData.total_items.toLocaleString()}</div>
          <div class="text-sm text-white/70">ì „ì²´ í•­ëª©</div>
        </div>
        <div class="bg-white/15 backdrop-blur-sm rounded-2xl px-6 py-4 border border-white/20">
          <div class="text-3xl font-black">{stats.paper.toLocaleString()}</div>
          <div class="text-sm text-white/70">ğŸ“œ Papers</div>
        </div>
        <div class="bg-white/15 backdrop-blur-sm rounded-2xl px-6 py-4 border border-white/20">
          <div class="text-3xl font-black">{stats.dev.toLocaleString()}</div>
          <div class="text-sm text-white/70">ğŸ§‘ğŸ»â€ğŸ’» Dev</div>
        </div>
        <div class="bg-white/15 backdrop-blur-sm rounded-2xl px-6 py-4 border border-white/20">
          <div class="text-3xl font-black">{stats.news.toLocaleString()}</div>
          <div class="text-sm text-white/70">ğŸ—ï¸ News</div>
        </div>
      </div>
    </div>
  </section>

  <!-- Quick Actions -->
  <section class="flex flex-wrap gap-3 mb-8">
    <a href="#latest" class="inline-flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-orange-500 to-red-500 text-white rounded-full font-medium hover:shadow-lg hover:shadow-orange-500/25 transition-all">
      ğŸ”¥ ìµœì‹  í•­ëª©
    </a>
    <a href={`${import.meta.env.BASE_URL}search`} class="inline-flex items-center gap-2 px-4 py-2 bg-gray-100 dark:bg-gray-800 rounded-full font-medium hover:bg-gray-200 dark:hover:bg-gray-700 transition-all">
      ğŸ” ìƒì„¸ ê²€ìƒ‰
    </a>
    <button id="filter-paper" class="filter-type-btn inline-flex items-center gap-2 px-4 py-2 bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 rounded-full font-medium hover:bg-blue-200 dark:hover:bg-blue-900/50 transition-all">
      ğŸ“œ Papers
    </button>
    <button id="filter-dev" class="filter-type-btn inline-flex items-center gap-2 px-4 py-2 bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300 rounded-full font-medium hover:bg-green-200 dark:hover:bg-green-900/50 transition-all">
      ğŸ§‘ğŸ»â€ğŸ’» Dev
    </button>
    <button id="filter-news" class="filter-type-btn inline-flex items-center gap-2 px-4 py-2 bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300 rounded-full font-medium hover:bg-purple-200 dark:hover:bg-purple-900/50 transition-all">
      ğŸ—ï¸ News
    </button>
    <button id="filter-all" class="inline-flex items-center gap-2 px-4 py-2 bg-gray-100 dark:bg-gray-800 rounded-full font-medium hover:bg-gray-200 dark:hover:bg-gray-700 transition-all">
      ì „ì²´ ë³´ê¸°
    </button>
  </section>

  <!-- Search Box -->
  <section class="mb-10">
    <div class="relative max-w-2xl">
      <input
        type="text"
        id="quick-search"
        placeholder="ë¹ ë¥¸ ê²€ìƒ‰... (ì œëª©, ê¸°ê´€, í‚¤ì›Œë“œ)"
        class="w-full px-5 py-4 pl-14 rounded-2xl border-2 border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-900 focus:border-indigo-500 dark:focus:border-indigo-400 outline-none transition-all text-lg"
      />
      <span class="absolute left-5 top-1/2 -translate-y-1/2 text-2xl">ğŸ”</span>
      <span id="search-count" class="absolute right-5 top-1/2 -translate-y-1/2 text-sm text-gray-400 hidden"></span>
    </div>
  </section>

  <!-- Latest Section -->
  <section id="latest" class="mb-16">
    <div class="flex items-center gap-3 mb-6">
      <h2 class="text-2xl font-bold">ğŸ”¥ ìµœì‹  í•­ëª©</h2>
      <span class="text-sm text-gray-500 dark:text-gray-400 bg-gray-100 dark:bg-gray-800 px-3 py-1 rounded-full">
        ìµœê·¼ 2ì£¼
      </span>
    </div>
    <div class="grid gap-4 md:grid-cols-2 lg:grid-cols-3" id="latest-grid">
      {latestItems.slice(0, 12).map((item) => (
        <ItemCard {...item} showWeek={true} />
      ))}
    </div>
    {latestItems.length > 12 && (
      <div class="text-center mt-6">
        <button id="show-more-latest" class="px-6 py-3 bg-gray-100 dark:bg-gray-800 rounded-xl font-medium hover:bg-gray-200 dark:hover:bg-gray-700 transition-all">
          +{latestItems.length - 12}ê°œ ë” ë³´ê¸°
        </button>
      </div>
    )}
  </section>

  <!-- All Items with Pagination -->
  <section id="all-items">
    <div class="flex items-center justify-between mb-6">
      <h2 class="text-2xl font-bold">ğŸ“‹ ì „ì²´ í•­ëª©</h2>
      <div class="text-sm text-gray-500">
        ì´ {sortedItems.length.toLocaleString()}ê°œ
      </div>
    </div>
    
    <!-- Month groups -->
    <div id="items-container">
      {groups.map((group, groupIndex) => (
        <div 
          class="mb-12 month-section" 
          data-year={group.year} 
          data-month={group.month}
          data-page={Math.floor(groupIndex / 3)}
        >
          <h3 class="flex items-center gap-3 text-xl font-bold mb-4 sticky top-16 bg-gray-50/95 dark:bg-gray-950/95 backdrop-blur-sm py-3 z-10 border-b border-gray-200 dark:border-gray-800">
            <span class="text-2xl">ğŸ“…</span>
            {group.year}ë…„ {monthNames[group.month] || group.month}
            <span class="text-sm font-normal text-gray-500 bg-gray-100 dark:bg-gray-800 px-2 py-0.5 rounded-full">
              {group.items.length}ê°œ
            </span>
          </h3>
          <div class="grid gap-4 md:grid-cols-2 items-grid">
            {group.items.map((item) => (
              <ItemCard {...item} showWeek={true} />
            ))}
          </div>
        </div>
      ))}
    </div>
    
    <!-- Pagination -->
    <div id="pagination" class="flex justify-center items-center gap-2 mt-8 mb-16">
      <button id="prev-page" class="px-4 py-2 bg-gray-100 dark:bg-gray-800 rounded-lg font-medium disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-200 dark:hover:bg-gray-700 transition-all">
        â† ì´ì „
      </button>
      <span id="page-info" class="px-4 py-2 text-gray-600 dark:text-gray-400">
        1 / {totalPages}
      </span>
      <button id="next-page" class="px-4 py-2 bg-gray-100 dark:bg-gray-800 rounded-lg font-medium disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-200 dark:hover:bg-gray-700 transition-all">
        ë‹¤ìŒ â†’
      </button>
    </div>
  </section>
  
  <!-- Back to top -->
  <button 
    id="back-to-top"
    class="fixed bottom-8 right-8 p-4 bg-indigo-600 text-white rounded-full shadow-lg shadow-indigo-600/30 opacity-0 pointer-events-none transition-all hover:bg-indigo-700 hover:scale-110 z-50"
  >
    â†‘
  </button>
</Layout>

<script define:vars={{ totalPages }}>
  // Pagination state
  let currentPage = 0;
  let currentFilter = 'all';
  const monthSections = document.querySelectorAll('.month-section');
  const cards = document.querySelectorAll('.card');
  const pageInfo = document.getElementById('page-info');
  const prevBtn = document.getElementById('prev-page');
  const nextBtn = document.getElementById('next-page');
  
  // Months per page
  const MONTHS_PER_PAGE = 3;
  const maxPage = Math.ceil(monthSections.length / MONTHS_PER_PAGE) - 1;
  
  function updatePagination() {
    monthSections.forEach((section, index) => {
      const sectionPage = Math.floor(index / MONTHS_PER_PAGE);
      const shouldShow = sectionPage === currentPage;
      
      // Also check filter
      if (shouldShow && currentFilter !== 'all') {
        const visibleCards = section.querySelectorAll(`.card[data-type="${currentFilter}"]:not([style*="display: none"])`);
        section.style.display = visibleCards.length > 0 ? '' : 'none';
      } else {
        section.style.display = shouldShow ? '' : 'none';
      }
    });
    
    pageInfo.textContent = `${currentPage + 1} / ${maxPage + 1}`;
    prevBtn.disabled = currentPage === 0;
    nextBtn.disabled = currentPage >= maxPage;
  }
  
  prevBtn?.addEventListener('click', () => {
    if (currentPage > 0) {
      currentPage--;
      updatePagination();
      document.getElementById('all-items')?.scrollIntoView({ behavior: 'smooth' });
    }
  });
  
  nextBtn?.addEventListener('click', () => {
    if (currentPage < maxPage) {
      currentPage++;
      updatePagination();
      document.getElementById('all-items')?.scrollIntoView({ behavior: 'smooth' });
    }
  });
  
  // Type filtering
  function filterByType(type) {
    currentFilter = type;
    currentPage = 0;
    
    cards.forEach((card) => {
      const cardType = card.getAttribute('data-type');
      card.style.display = (type === 'all' || cardType === type) ? '' : 'none';
    });
    
    updatePagination();
  }
  
  document.getElementById('filter-paper')?.addEventListener('click', () => filterByType('paper'));
  document.getElementById('filter-dev')?.addEventListener('click', () => filterByType('dev'));
  document.getElementById('filter-news')?.addEventListener('click', () => filterByType('news'));
  document.getElementById('filter-all')?.addEventListener('click', () => filterByType('all'));
  
  // Quick search
  const searchInput = document.getElementById('quick-search');
  const searchCount = document.getElementById('search-count');
  const latestSection = document.getElementById('latest');
  const allItemsSection = document.getElementById('all-items');
  
  searchInput?.addEventListener('input', (e) => {
    const query = e.target.value.toLowerCase().trim();
    
    if (!query) {
      cards.forEach(card => card.style.display = '');
      searchCount?.classList.add('hidden');
      latestSection.style.display = '';
      currentPage = 0;
      updatePagination();
      return;
    }
    
    // Hide latest section during search
    latestSection.style.display = 'none';
    
    // Show all months during search
    monthSections.forEach(s => s.style.display = '');
    
    let visibleCount = 0;
    cards.forEach((card) => {
      const text = (card.textContent || '').toLowerCase();
      const title = card.getAttribute('data-title') || '';
      const org = card.getAttribute('data-org') || '';
      const matches = text.includes(query) || title.includes(query) || org.includes(query);
      card.style.display = matches ? '' : 'none';
      if (matches) visibleCount++;
    });
    
    // Hide empty sections
    monthSections.forEach((section) => {
      const visible = section.querySelectorAll('.card:not([style*="display: none"])');
      section.style.display = visible.length > 0 ? '' : 'none';
    });
    
    searchCount.textContent = `${visibleCount}ê°œ ê²°ê³¼`;
    searchCount?.classList.remove('hidden');
  });
  
  // Show more latest
  const showMoreLatestBtn = document.getElementById('show-more-latest');
  const latestGrid = document.getElementById('latest-grid');
  
  showMoreLatestBtn?.addEventListener('click', () => {
    // This would need dynamic loading - for now just scroll to all items
    document.getElementById('all-items')?.scrollIntoView({ behavior: 'smooth' });
  });
  
  // Back to top
  const backToTop = document.getElementById('back-to-top');
  
  window.addEventListener('scroll', () => {
    if (window.scrollY > 500) {
      backToTop?.classList.remove('opacity-0', 'pointer-events-none');
    } else {
      backToTop?.classList.add('opacity-0', 'pointer-events-none');
    }
  });
  
  backToTop?.addEventListener('click', () => {
    window.scrollTo({ top: 0, behavior: 'smooth' });
  });
  
  // Initialize
  updatePagination();
</script>
