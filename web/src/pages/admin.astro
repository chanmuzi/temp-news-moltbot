---
import Layout from '../layouts/Layout.astro';

// Get current date info for defaults
const now = new Date();
const currentYear = now.getFullYear().toString();
const currentMonth = (now.getMonth() + 1).toString();
const currentWeek = Math.ceil(now.getDate() / 7).toString();
---

<Layout title="í•­ëª© ì¶”ê°€ - NLP Paper News">
  <section class="max-w-3xl mx-auto">
    <!-- Header -->
    <div class="flex items-center gap-3 mb-6">
      <a href={import.meta.env.BASE_URL} class="text-sand-400 hover:text-claude-500 transition-colors text-sm">
        <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
        í™ˆ
      </a>
    </div>

    <div class="mb-6">
      <h1 class="text-2xl font-bold text-sand-800 dark:text-sand-100 mb-1">ìƒˆ í•­ëª© ì¶”ê°€</h1>
      <p class="text-sm text-sand-500 dark:text-sand-500">
        ë§ˆí¬ë‹¤ìš´ì„ ë¶™ì—¬ë„£ìœ¼ë©´ ìë™ìœ¼ë¡œ íŒŒì‹±ë©ë‹ˆë‹¤.
      </p>
    </div>

    <!-- GitHub Token Setup (collapsible) -->
    <div class="mb-6">
      <button id="toggle-settings" class="flex items-center gap-2 text-sm text-sand-400 hover:text-claude-500 transition-colors">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.066 2.573c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.573 1.066c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.066-2.573c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
        GitHub ì—°ê²° ì„¤ì •
        <span id="token-status" class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs"></span>
      </button>
      <div id="settings-panel" class="hidden mt-3 p-4 bg-white dark:bg-anthro-darkSurface rounded-xl border border-sand-200 dark:border-sand-800">
        <p class="text-xs text-sand-500 dark:text-sand-500 mb-3">
          GitHub Personal Access Tokenì„ ì…ë ¥í•˜ë©´ ë¸Œë¼ìš°ì €ì—ì„œ ì§ì ‘ í•­ëª©ì„ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br/>
          í† í°ì€ ë¸Œë¼ìš°ì € localStorageì—ë§Œ ì €ì¥ë˜ë©° ì™¸ë¶€ë¡œ ì „ì†¡ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤ (GitHub API ì œì™¸).
        </p>
        <div class="flex gap-2">
          <input
            type="password"
            id="github-token"
            placeholder="ghp_xxxxxxxxxxxxxxxxxxxx"
            class="flex-1 px-3 py-2 rounded-lg border border-sand-200 dark:border-sand-700 bg-sand-50 dark:bg-anthro-darkMid text-sm text-sand-800 dark:text-sand-100 outline-none focus:border-claude-500 transition-all font-mono"
          />
          <button id="save-token" class="px-4 py-2 rounded-lg bg-claude-500 text-white text-sm font-medium hover:bg-claude-600 transition-all">
            ì €ì¥
          </button>
          <button id="clear-token" class="px-3 py-2 rounded-lg border border-sand-200 dark:border-sand-700 text-sm text-sand-500 hover:text-red-500 hover:border-red-300 transition-all">
            ì‚­ì œ
          </button>
        </div>
        <div class="mt-3">
          <label class="block text-xs text-sand-500 mb-1">Repository (owner/repo)</label>
          <input
            type="text"
            id="github-repo"
            value="chanmuzi/temp-news-moltbot"
            class="w-full px-3 py-2 rounded-lg border border-sand-200 dark:border-sand-700 bg-sand-50 dark:bg-anthro-darkMid text-sm text-sand-800 dark:text-sand-100 outline-none focus:border-claude-500 transition-all font-mono"
          />
        </div>
      </div>
    </div>

    <!-- Markdown Input -->
    <div class="bg-white dark:bg-anthro-darkSurface rounded-xl border border-sand-200 dark:border-sand-800 p-5 mb-6">
      <h2 class="text-sm font-semibold text-sand-500 dark:text-sand-500 uppercase tracking-wider mb-4">ë§ˆí¬ë‹¤ìš´ ì…ë ¥</h2>

      <!-- Date inputs -->
      <div class="flex gap-3 mb-4">
        <div>
          <label class="block text-xs text-sand-400 mb-1">ë…„</label>
          <input type="number" id="input-year" value={currentYear} min="2020" max="2030"
            class="w-20 px-3 py-2 rounded-lg border border-sand-200 dark:border-sand-700 bg-sand-50 dark:bg-anthro-darkMid text-sm text-sand-800 dark:text-sand-100 outline-none focus:border-claude-500 transition-all font-mono" />
        </div>
        <div>
          <label class="block text-xs text-sand-400 mb-1">ì›”</label>
          <input type="number" id="input-month" value={currentMonth} min="1" max="12"
            class="w-16 px-3 py-2 rounded-lg border border-sand-200 dark:border-sand-700 bg-sand-50 dark:bg-anthro-darkMid text-sm text-sand-800 dark:text-sand-100 outline-none focus:border-claude-500 transition-all font-mono" />
        </div>
        <div>
          <label class="block text-xs text-sand-400 mb-1">ì£¼ì°¨</label>
          <input type="number" id="input-week" value={currentWeek} min="1" max="5"
            class="w-16 px-3 py-2 rounded-lg border border-sand-200 dark:border-sand-700 bg-sand-50 dark:bg-anthro-darkMid text-sm text-sand-800 dark:text-sand-100 outline-none focus:border-claude-500 transition-all font-mono" />
        </div>
      </div>

      <textarea
        id="markdown-input"
        rows="10"
        placeholder="- ğŸ“œ [Anthropic, Stanford] [**Shaping capabilities with token-level data filtering**](https://arxiv.org/abs/2601.21571)
    - ì–¸ì–´ ëª¨ë¸ì˜ undesired capabilitiesë¥¼ ì¤„ì´ëŠ” ëŒ€ë¶€ë¶„ì˜ ë°©ì‹ì€ post hoc ìŠ¤íƒ€ì¼ì„ì„ ë¬¸ì œì ìœ¼ë¡œ ì§€ì 
        - â†’ ëŒ€ì‹  pretraining ë™ì•ˆì— í•´ê²°ë˜ì–´ì•¼ í•˜ëŠ” ê²ƒìœ¼ë¡œ ëŒ€ì•ˆ ì œì‹œ"
        class="w-full px-4 py-3 rounded-xl border border-sand-200 dark:border-sand-700 bg-sand-50 dark:bg-anthro-darkMid text-sm text-sand-800 dark:text-sand-100 placeholder-sand-400 dark:placeholder-sand-600 outline-none focus:border-claude-500 transition-all font-mono leading-relaxed"
      ></textarea>

      <div class="mt-4 flex gap-2">
        <button id="parse-btn" class="px-5 py-2.5 bg-claude-500 text-white rounded-lg text-sm font-medium hover:bg-claude-600 transition-all shadow-sm">
          íŒŒì‹± ë¯¸ë¦¬ë³´ê¸°
        </button>
        <button id="clear-btn" class="px-4 py-2.5 rounded-lg border border-sand-200 dark:border-sand-700 text-sm text-sand-500 hover:text-sand-700 dark:hover:text-sand-300 transition-all">
          ì§€ìš°ê¸°
        </button>
      </div>
    </div>

    <!-- Preview -->
    <div id="preview-section" class="hidden mb-6">
      <h2 class="text-sm font-semibold text-sand-500 dark:text-sand-500 uppercase tracking-wider mb-3">ë¯¸ë¦¬ë³´ê¸°</h2>
      <div id="preview-container" class="space-y-3"></div>

      <!-- Actions -->
      <div class="mt-6 flex gap-2">
        <button id="submit-btn" class="px-5 py-2.5 bg-claude-500 text-white rounded-lg text-sm font-medium hover:bg-claude-600 transition-all shadow-sm disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
          GitHubì— ì¶”ê°€
        </button>
        <button id="copy-json" class="px-4 py-2.5 rounded-lg border border-sand-200 dark:border-sand-700 text-sm text-sand-500 hover:text-sand-700 dark:hover:text-sand-300 transition-all">
          JSON ë³µì‚¬
        </button>
      </div>

      <!-- Submit status -->
      <div id="submit-status" class="hidden mt-4 p-4 rounded-xl text-sm"></div>

      <!-- JSON output (collapsible) -->
      <details class="mt-4">
        <summary class="text-xs text-sand-400 cursor-pointer hover:text-sand-600 transition-colors">JSON ì¶œë ¥ ë³´ê¸°</summary>
        <pre id="json-output" class="mt-2 bg-anthro-dark text-claude-300 p-4 rounded-lg overflow-x-auto text-xs font-mono"></pre>
      </details>
    </div>

    <!-- Format Guide -->
    <details class="mb-8">
      <summary class="text-sm font-medium text-sand-400 cursor-pointer hover:text-claude-500 transition-colors">ì§€ì› í˜•ì‹ ì•ˆë‚´</summary>
      <div class="mt-3 p-4 bg-white dark:bg-anthro-darkSurface rounded-xl border border-sand-200 dark:border-sand-800 space-y-3 text-sm">
        <div>
          <h3 class="font-medium text-blue-600 dark:text-blue-400 mb-1">ğŸ“œ Paper</h3>
          <code class="block bg-sand-50 dark:bg-anthro-darkMid p-2 rounded-lg text-xs font-mono text-sand-600 dark:text-sand-400 overflow-x-auto">- ğŸ“œ [ê¸°ê´€ëª…] [**ë…¼ë¬¸ ì œëª©**](https://arxiv.org/abs/...)<br/>    - ì„¤ëª… 1<br/>        - í•˜ìœ„ ì„¤ëª…</code>
        </div>
        <div>
          <h3 class="font-medium text-emerald-600 dark:text-emerald-400 mb-1">ğŸ§‘ğŸ»â€ğŸ’» Dev</h3>
          <code class="block bg-sand-50 dark:bg-anthro-darkMid p-2 rounded-lg text-xs font-mono text-sand-600 dark:text-sand-400 overflow-x-auto">- ğŸ§‘ğŸ»â€ğŸ’» [ê¸°ê´€ëª…] [ì œëª©](URL)<br/>    - ì„¤ëª…</code>
        </div>
        <div>
          <h3 class="font-medium text-violet-600 dark:text-violet-400 mb-1">ğŸ—ï¸ News</h3>
          <code class="block bg-sand-50 dark:bg-anthro-darkMid p-2 rounded-lg text-xs font-mono text-sand-600 dark:text-sand-400 overflow-x-auto">- ğŸ—ï¸ [ê¸°ê´€ëª…] [ì œëª©](URL)<br/>    - ì„¤ëª…</code>
        </div>
      </div>
    </details>
  </section>
</Layout>

<script>
  const TYPE_MAP: Record<string, string> = {
    'ğŸ“œ': 'paper',
    'ğŸ§‘ğŸ»â€ğŸ’»': 'dev',
    'ğŸ§‘ğŸ»ğŸ’»': 'dev',
    'ğŸ—ï¸': 'news',
    'ğŸ—': 'news',
  };

  let parsedItems: any[] = [];

  function parseMarkdownItems(text: string, year: string, month: string, week: string) {
    const lines = text.split('\n');
    const items: any[] = [];
    let currentItem: any = null;

    for (const line of lines) {
      const iconMatch = line.match(/^-\s*(ğŸ“œ|ğŸ§‘ğŸ»â€ğŸ’»|ğŸ§‘ğŸ»ğŸ’»|ğŸ—ï¸|ğŸ—)/);

      if (iconMatch) {
        if (currentItem) items.push(currentItem);

        const icon = iconMatch[1];
        const type = TYPE_MAP[icon] || 'paper';
        const afterIcon = line.slice(iconMatch[0].length).trim();

        const orgMatch = afterIcon.match(/^\[([^\]]+)\]\s*/);
        if (!orgMatch) continue;

        const org = orgMatch[1];
        const afterOrg = afterIcon.slice(orgMatch[0].length);

        let title = '';
        let url = '';

        if (afterOrg.startsWith('[')) {
          let bracketCount = 0;
          let titleEnd = -1;

          for (let i = 0; i < afterOrg.length; i++) {
            if (afterOrg[i] === '[') bracketCount++;
            else if (afterOrg[i] === ']') {
              bracketCount--;
              if (bracketCount === 0) { titleEnd = i; break; }
            }
          }

          if (titleEnd > 0) {
            title = afterOrg.slice(1, titleEnd).replace(/\*\*/g, '').trim();
            const afterTitle = afterOrg.slice(titleEnd + 1).trim();
            const urlMatch = afterTitle.match(/^\(([^)]+)\)/);
            if (urlMatch) url = urlMatch[1];
          }
        }

        if (!title) continue;

        const id = `${org}-${title}`
          .toLowerCase()
          .replace(/[^a-z0-9ê°€-í£\s-]/g, '')
          .replace(/\s+/g, '-')
          .slice(0, 100);

        currentItem = {
          id, type, org, title, url,
          date: `${year}-${month.padStart(2, '0')}-W${week.padStart(2, '0')}`,
          year, month, week,
          bullets: [], tags: [],
        };
        continue;
      }

      if (currentItem && line.match(/^\s+-\s+/)) {
        const match = line.match(/^(\s*)-\s+(.+)$/);
        if (match) {
          const indent = match[1].length;
          const bulletText = match[2].trim();
          const level = indent < 4 ? 1 : indent < 8 ? 2 : 3;
          currentItem.bullets.push({ text: bulletText, level });
        }
      }
    }

    if (currentItem) items.push(currentItem);
    return items;
  }

  function renderPreview(items: any[]) {
    const container = document.getElementById('preview-container');
    if (!container) return;

    const typeInfo: Record<string, { icon: string; color: string; bg: string }> = {
      paper: { icon: 'ğŸ“œ', color: 'text-blue-700 dark:text-blue-300', bg: 'bg-blue-50 dark:bg-blue-950/20 border-blue-100 dark:border-blue-900/30' },
      dev: { icon: 'ğŸ§‘ğŸ»â€ğŸ’»', color: 'text-emerald-700 dark:text-emerald-300', bg: 'bg-emerald-50 dark:bg-emerald-950/20 border-emerald-100 dark:border-emerald-900/30' },
      news: { icon: 'ğŸ—ï¸', color: 'text-violet-700 dark:text-violet-300', bg: 'bg-violet-50 dark:bg-violet-950/20 border-violet-100 dark:border-violet-900/30' },
    };

    container.innerHTML = items.map(item => {
      const info = typeInfo[item.type] || typeInfo.paper;
      return `
        <div class="p-4 rounded-xl border ${info.bg}">
          <div class="flex items-center gap-2 mb-2">
            <span class="text-xs font-semibold ${info.color}">${info.icon} ${item.type.toUpperCase()}</span>
            <span class="text-sm font-medium text-sand-600 dark:text-sand-400">${item.org}</span>
            <span class="text-xs text-sand-400 font-mono ml-auto">${item.date}</span>
          </div>
          <h3 class="font-semibold text-sand-800 dark:text-sand-100 mb-2">${item.title}</h3>
          ${item.url ? `<a href="${item.url}" target="_blank" class="text-xs text-claude-500 hover:underline mb-2 block truncate">${item.url}</a>` : ''}
          ${item.bullets.length > 0 ? `
            <ul class="text-sm text-sand-600 dark:text-sand-400 space-y-1">
              ${item.bullets.map((b: any) => `
                <li class="${b.level > 1 ? 'ml-4 text-xs text-sand-500' : ''} flex items-start gap-2">
                  <span class="mt-[7px] w-1 h-1 rounded-full bg-sand-400 flex-shrink-0"></span>
                  <span>${b.text}</span>
                </li>
              `).join('')}
            </ul>
          ` : ''}
        </div>
      `;
    }).join('');
  }

  // GitHub API integration
  async function submitToGitHub(items: any[]) {
    const token = localStorage.getItem('github_token');
    const repo = (document.getElementById('github-repo') as HTMLInputElement)?.value || 'chanmuzi/temp-news-moltbot';
    const statusEl = document.getElementById('submit-status');
    const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;

    if (!token) {
      showStatus('GitHub í† í°ì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ìƒë‹¨ì˜ "GitHub ì—°ê²° ì„¤ì •"ì—ì„œ í† í°ì„ ì…ë ¥í•˜ì„¸ìš”.', 'error');
      return;
    }

    submitBtn.disabled = true;
    showStatus('GitHubì—ì„œ í˜„ì¬ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘...', 'info');

    try {
      // 1. Get current file content
      const getRes = await fetch(`https://api.github.com/repos/${repo}/contents/data/items.json`, {
        headers: { 'Authorization': `token ${token}`, 'Accept': 'application/vnd.github.v3+json' }
      });

      if (!getRes.ok) {
        throw new Error(`GitHub API error: ${getRes.status} ${getRes.statusText}`);
      }

      const fileData = await getRes.json();
      const currentContent = JSON.parse(atob(fileData.content.replace(/\n/g, '')));

      // 2. Merge new items (prepend, avoid duplicates)
      const existingIds = new Set(currentContent.items.map((i: any) => i.id));
      const newItems = items.filter(i => !existingIds.has(i.id));

      if (newItems.length === 0) {
        showStatus('ì¶”ê°€í•  ìƒˆ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤ (ì´ë¯¸ ì¡´ì¬í•˜ëŠ” í•­ëª©ì…ë‹ˆë‹¤).', 'warn');
        submitBtn.disabled = false;
        return;
      }

      currentContent.items = [...newItems, ...currentContent.items];
      currentContent.total_items = currentContent.items.length;
      currentContent.last_updated = new Date().toISOString();

      // Recalculate stats
      currentContent.stats = {
        total: currentContent.items.length,
        paper: currentContent.items.filter((i: any) => i.type === 'paper').length,
        dev: currentContent.items.filter((i: any) => i.type === 'dev').length,
        news: currentContent.items.filter((i: any) => i.type === 'news').length,
      };

      // 3. Commit to GitHub
      showStatus('ì»¤ë°‹ ì¤‘...', 'info');

      const newContent = btoa(unescape(encodeURIComponent(JSON.stringify(currentContent, null, 2))));
      const titles = newItems.map((i: any) => i.title).slice(0, 3).join(', ');
      const commitMessage = `Add ${newItems.length} item(s): ${titles}`;

      const putRes = await fetch(`https://api.github.com/repos/${repo}/contents/data/items.json`, {
        method: 'PUT',
        headers: {
          'Authorization': `token ${token}`,
          'Accept': 'application/vnd.github.v3+json',
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          message: commitMessage,
          content: newContent,
          sha: fileData.sha,
        }),
      });

      if (!putRes.ok) {
        const errData = await putRes.json();
        throw new Error(`Commit failed: ${errData.message}`);
      }

      showStatus(`${newItems.length}ê°œ í•­ëª©ì´ ì„±ê³µì ìœ¼ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤! GitHub Actionsê°€ ìë™ìœ¼ë¡œ ì‚¬ì´íŠ¸ë¥¼ ë¹Œë“œí•©ë‹ˆë‹¤.`, 'success');

    } catch (err: any) {
      showStatus(`ì˜¤ë¥˜: ${err.message}`, 'error');
    } finally {
      submitBtn.disabled = false;
    }
  }

  function showStatus(message: string, type: 'info' | 'success' | 'error' | 'warn') {
    const el = document.getElementById('submit-status');
    if (!el) return;
    el.classList.remove('hidden');

    const colors: Record<string, string> = {
      info: 'bg-blue-50 dark:bg-blue-950/30 text-blue-700 dark:text-blue-300 border border-blue-200 dark:border-blue-800',
      success: 'bg-emerald-50 dark:bg-emerald-950/30 text-emerald-700 dark:text-emerald-300 border border-emerald-200 dark:border-emerald-800',
      error: 'bg-red-50 dark:bg-red-950/30 text-red-700 dark:text-red-300 border border-red-200 dark:border-red-800',
      warn: 'bg-amber-50 dark:bg-amber-950/30 text-amber-700 dark:text-amber-300 border border-amber-200 dark:border-amber-800',
    };
    el.className = `mt-4 p-4 rounded-xl text-sm ${colors[type]}`;
    el.textContent = message;
  }

  function updateTokenStatus() {
    const statusEl = document.getElementById('token-status');
    const token = localStorage.getItem('github_token');
    if (statusEl) {
      if (token) {
        statusEl.textContent = 'ì—°ê²°ë¨';
        statusEl.className = 'inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs bg-emerald-100 dark:bg-emerald-900/30 text-emerald-600 dark:text-emerald-400';
      } else {
        statusEl.textContent = 'ë¯¸ì—°ê²°';
        statusEl.className = 'inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs bg-sand-100 dark:bg-sand-800 text-sand-400';
      }
    }
  }

  // Event handlers
  document.getElementById('toggle-settings')?.addEventListener('click', () => {
    document.getElementById('settings-panel')?.classList.toggle('hidden');
  });

  document.getElementById('save-token')?.addEventListener('click', () => {
    const input = document.getElementById('github-token') as HTMLInputElement;
    if (input.value.trim()) {
      localStorage.setItem('github_token', input.value.trim());
      input.value = '';
      updateTokenStatus();
      showToast('í† í°ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
    }
  });

  document.getElementById('clear-token')?.addEventListener('click', () => {
    localStorage.removeItem('github_token');
    updateTokenStatus();
    showToast('í† í°ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
  });

  document.getElementById('parse-btn')?.addEventListener('click', () => {
    const textarea = document.getElementById('markdown-input') as HTMLTextAreaElement;
    const year = (document.getElementById('input-year') as HTMLInputElement).value;
    const month = (document.getElementById('input-month') as HTMLInputElement).value;
    const week = (document.getElementById('input-week') as HTMLInputElement).value;

    parsedItems = parseMarkdownItems(textarea.value, year, month, week);

    if (parsedItems.length === 0) {
      showToast('íŒŒì‹±ëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤. í˜•ì‹ì„ í™•ì¸í•˜ì„¸ìš”.');
      return;
    }

    document.getElementById('preview-section')?.classList.remove('hidden');
    renderPreview(parsedItems);

    const jsonOutput = document.getElementById('json-output');
    if (jsonOutput) {
      jsonOutput.textContent = JSON.stringify(parsedItems, null, 2);
    }
  });

  document.getElementById('clear-btn')?.addEventListener('click', () => {
    (document.getElementById('markdown-input') as HTMLTextAreaElement).value = '';
    document.getElementById('preview-section')?.classList.add('hidden');
    document.getElementById('submit-status')?.classList.add('hidden');
    parsedItems = [];
  });

  document.getElementById('submit-btn')?.addEventListener('click', () => {
    if (parsedItems.length > 0) {
      submitToGitHub(parsedItems);
    }
  });

  document.getElementById('copy-json')?.addEventListener('click', () => {
    const jsonOutput = document.getElementById('json-output');
    if (jsonOutput) {
      navigator.clipboard.writeText(jsonOutput.textContent || '');
      showToast('JSONì´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤');
    }
  });

  function showToast(message: string) {
    const existing = document.querySelector('.toast');
    if (existing) existing.remove();
    const toast = document.createElement('div');
    toast.className = 'toast';
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
  }

  // Initialize
  updateTokenStatus();

  // Load saved repo
  const savedRepo = localStorage.getItem('github_repo');
  if (savedRepo) {
    (document.getElementById('github-repo') as HTMLInputElement).value = savedRepo;
  }

  document.getElementById('github-repo')?.addEventListener('change', (e) => {
    localStorage.setItem('github_repo', (e.target as HTMLInputElement).value);
  });
</script>
