---
import Layout from '../layouts/Layout.astro';

// Get current date info for defaults
const now = new Date();
const currentYear = now.getFullYear().toString();
const currentMonth = (now.getMonth() + 1).toString();
const currentWeek = Math.ceil(now.getDate() / 7).toString();
---

<Layout title="í•­ëª© ì¶”ê°€ - NLP Paper News">
  <section class="max-w-4xl mx-auto">
    <div class="mb-8">
      <h1 class="text-3xl font-bold mb-2">âœï¸ ìƒˆ í•­ëª© ì¶”ê°€</h1>
      <p class="text-gray-600 dark:text-gray-400">
        ê¸°ì¡´ ë§ˆí¬ë‹¤ìš´ í˜•ì‹ì„ ê·¸ëŒ€ë¡œ ë¶™ì—¬ë„£ìœ¼ë©´ ìë™ìœ¼ë¡œ íŒŒì‹±ë©ë‹ˆë‹¤.
      </p>
    </div>

    <!-- Markdown Input -->
    <div class="card bg-white dark:bg-gray-900 rounded-2xl border-2 border-gray-200 dark:border-gray-800 p-6 mb-8">
      <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
        ğŸ“ ë§ˆí¬ë‹¤ìš´ ì…ë ¥
        <span class="text-sm font-normal text-gray-500">(ì—¬ëŸ¬ í•­ëª© ë™ì‹œ ì…ë ¥ ê°€ëŠ¥)</span>
      </h2>
      
      <div class="mb-4">
        <label class="block text-sm font-medium mb-2">ë‚ ì§œ ì •ë³´</label>
        <div class="flex gap-3">
          <div>
            <input type="number" id="input-year" value={currentYear} min="2020" max="2030" 
              class="w-24 px-3 py-2 rounded-lg border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800" />
            <span class="text-sm text-gray-500 ml-1">ë…„</span>
          </div>
          <div>
            <input type="number" id="input-month" value={currentMonth} min="1" max="12"
              class="w-20 px-3 py-2 rounded-lg border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800" />
            <span class="text-sm text-gray-500 ml-1">ì›”</span>
          </div>
          <div>
            <input type="number" id="input-week" value={currentWeek} min="1" max="5"
              class="w-20 px-3 py-2 rounded-lg border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800" />
            <span class="text-sm text-gray-500 ml-1">ì£¼ì°¨</span>
          </div>
        </div>
      </div>
      
      <textarea 
        id="markdown-input"
        rows="12"
        placeholder="- ğŸ“œ [Anthropic, Stanford] [**Shaping capabilities with token-level data filtering**](https://arxiv.org/abs/2601.21571)
    - ì–¸ì–´ ëª¨ë¸ì˜ undesired capabilitiesë¥¼ ì¤„ì´ëŠ” ëŒ€ë¶€ë¶„ì˜ ë°©ì‹ì€ post hoc ìŠ¤íƒ€ì¼ì„ì„ ë¬¸ì œì ìœ¼ë¡œ ì§€ì 
        - â†’ ëŒ€ì‹  pretraining ë™ì•ˆì— í•´ê²°ë˜ì–´ì•¼ í•˜ëŠ” ê²ƒìœ¼ë¡œ ëŒ€ì•ˆ ì œì‹œ
    - ì˜ë£Œ ë„ë©”ì¸ì„ ëŒ€ìƒìœ¼ë¡œ documents filteringë³´ë‹¤ tokens filteringì´ í›¨ì”¬ ë” íš¨ê³¼ì ì´ì—ˆìŒì„ ì…ì¦

- ğŸ§‘ğŸ»â€ğŸ’» [OpenAI] [Introducing GPT-5.2](https://openai.com/index/introducing-gpt-5-2/)
    - ChatGPT - Instant/Thinking/Pro, API - 5.2/5.2-chat-latest/5.2-pro"
        class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 focus:border-indigo-500 dark:focus:border-indigo-400 outline-none transition-all font-mono text-sm"
      ></textarea>
      
      <div class="mt-4 flex gap-3">
        <button id="parse-btn" class="px-6 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-xl font-bold hover:shadow-lg hover:shadow-indigo-500/25 transition-all">
          ğŸ” íŒŒì‹± ë¯¸ë¦¬ë³´ê¸°
        </button>
        <button id="clear-btn" class="px-6 py-3 bg-gray-100 dark:bg-gray-800 rounded-xl font-medium hover:bg-gray-200 dark:hover:bg-gray-700 transition-all">
          ì§€ìš°ê¸°
        </button>
      </div>
    </div>

    <!-- Preview -->
    <div id="preview-section" class="hidden mb-8">
      <h2 class="text-xl font-bold mb-4">ğŸ‘€ ë¯¸ë¦¬ë³´ê¸°</h2>
      <div id="preview-container" class="space-y-4"></div>
      
      <div class="mt-6 p-4 bg-amber-50 dark:bg-amber-950/30 rounded-xl border border-amber-200 dark:border-amber-800">
        <h3 class="font-bold text-amber-800 dark:text-amber-200 mb-2">ğŸ“‹ JSON ì¶œë ¥</h3>
        <p class="text-sm text-amber-700 dark:text-amber-300 mb-3">
          ì•„ë˜ JSONì„ ë³µì‚¬í•˜ì—¬ <code class="bg-amber-100 dark:bg-amber-900 px-1 rounded">data/items.json</code>ì˜ items ë°°ì—´ ë§¨ ì•ì— ì¶”ê°€í•˜ì„¸ìš”.
        </p>
        <pre id="json-output" class="bg-gray-900 text-green-400 p-4 rounded-lg overflow-x-auto text-xs"></pre>
        <button id="copy-json" class="mt-3 px-4 py-2 bg-amber-600 text-white rounded-lg font-medium hover:bg-amber-700 transition-all">
          ğŸ“‹ JSON ë³µì‚¬
        </button>
      </div>
    </div>

    <!-- Format Guide -->
    <div class="card bg-gray-50 dark:bg-gray-900/50 rounded-2xl border border-gray-200 dark:border-gray-800 p-6">
      <h2 class="text-lg font-bold mb-4">ğŸ“– ì§€ì› í˜•ì‹</h2>
      <div class="space-y-4 text-sm">
        <div>
          <h3 class="font-semibold text-indigo-600 dark:text-indigo-400 mb-1">ğŸ“œ Paper</h3>
          <code class="block bg-gray-100 dark:bg-gray-800 p-3 rounded-lg text-xs overflow-x-auto">
- ğŸ“œ [ê¸°ê´€ëª…] [**ë…¼ë¬¸ ì œëª©**](https://arxiv.org/abs/...)
    - ì„¤ëª… 1
    - ì„¤ëª… 2
        - í•˜ìœ„ ì„¤ëª…
          </code>
        </div>
        <div>
          <h3 class="font-semibold text-green-600 dark:text-green-400 mb-1">ğŸ§‘ğŸ»â€ğŸ’» Dev</h3>
          <code class="block bg-gray-100 dark:bg-gray-800 p-3 rounded-lg text-xs overflow-x-auto">
- ğŸ§‘ğŸ»â€ğŸ’» [ê¸°ê´€ëª…] [ì œëª©](URL)
    - ì„¤ëª…
          </code>
        </div>
        <div>
          <h3 class="font-semibold text-purple-600 dark:text-purple-400 mb-1">ğŸ—ï¸ News</h3>
          <code class="block bg-gray-100 dark:bg-gray-800 p-3 rounded-lg text-xs overflow-x-auto">
- ğŸ—ï¸ [ê¸°ê´€ëª…] [ì œëª©](URL)
    - ì„¤ëª…
          </code>
        </div>
      </div>
    </div>
  </section>
</Layout>

<script>
  const TYPE_MAP: Record<string, string> = {
    'ğŸ“œ': 'paper',
    'ğŸ§‘ğŸ»â€ğŸ’»': 'dev',
    'ğŸ§‘ğŸ»ğŸ’»': 'dev',
    'ğŸ—ï¸': 'news',
    'ğŸ—': 'news',
  };

  function parseMarkdownItems(text: string, year: string, month: string, week: string) {
    const lines = text.split('\n');
    const items: any[] = [];
    let currentItem: any = null;

    for (const line of lines) {
      // Check for item header
      const iconMatch = line.match(/^-\s*(ğŸ“œ|ğŸ§‘ğŸ»â€ğŸ’»|ğŸ§‘ğŸ»ğŸ’»|ğŸ—ï¸|ğŸ—)/);
      
      if (iconMatch) {
        // Save previous item
        if (currentItem) {
          items.push(currentItem);
        }

        const icon = iconMatch[1];
        const type = TYPE_MAP[icon] || 'paper';
        const afterIcon = line.slice(iconMatch[0].length).trim();

        // Extract [Org]
        const orgMatch = afterIcon.match(/^\[([^\]]+)\]\s*/);
        if (!orgMatch) continue;

        const org = orgMatch[1];
        const afterOrg = afterIcon.slice(orgMatch[0].length);

        // Extract [Title](URL)
        let title = '';
        let url = '';

        if (afterOrg.startsWith('[')) {
          let bracketCount = 0;
          let titleEnd = -1;

          for (let i = 0; i < afterOrg.length; i++) {
            if (afterOrg[i] === '[') bracketCount++;
            else if (afterOrg[i] === ']') {
              bracketCount--;
              if (bracketCount === 0) {
                titleEnd = i;
                break;
              }
            }
          }

          if (titleEnd > 0) {
            title = afterOrg.slice(1, titleEnd).replace(/\*\*/g, '').trim();
            const afterTitle = afterOrg.slice(titleEnd + 1).trim();
            const urlMatch = afterTitle.match(/^\(([^)]+)\)/);
            if (urlMatch) {
              url = urlMatch[1];
            }
          }
        }

        if (!title) continue;

        const id = `${org}-${title}`
          .toLowerCase()
          .replace(/[^a-z0-9ê°€-í£\s-]/g, '')
          .replace(/\s+/g, '-')
          .slice(0, 100);

        currentItem = {
          id,
          date: `${year}-${month.padStart(2, '0')}-W${week.padStart(2, '0')}`,
          year,
          month,
          week,
          type,
          org,
          title,
          url,
          bullets: [],
          tags: [],
        };
        continue;
      }

      // Check for bullet
      if (currentItem && line.match(/^\s+-\s+/)) {
        const match = line.match(/^(\s*)-\s+(.+)$/);
        if (match) {
          const indent = match[1].length;
          const bulletText = match[2].trim();
          const level = indent < 4 ? 1 : indent < 8 ? 2 : 3;
          currentItem.bullets.push({ text: bulletText, level });
        }
      }
    }

    // Don't forget last item
    if (currentItem) {
      items.push(currentItem);
    }

    return items;
  }

  function renderPreview(items: any[]) {
    const container = document.getElementById('preview-container');
    if (!container) return;

    const typeLabels: Record<string, { icon: string; bg: string }> = {
      paper: { icon: 'ğŸ“œ', bg: 'bg-blue-100 dark:bg-blue-900/30' },
      dev: { icon: 'ğŸ§‘ğŸ»â€ğŸ’»', bg: 'bg-green-100 dark:bg-green-900/30' },
      news: { icon: 'ğŸ—ï¸', bg: 'bg-purple-100 dark:bg-purple-900/30' },
    };

    container.innerHTML = items.map(item => {
      const info = typeLabels[item.type] || typeLabels.paper;
      return `
        <div class="p-4 rounded-xl border-2 ${info.bg} border-gray-200 dark:border-gray-700">
          <div class="flex items-center gap-2 mb-2">
            <span class="text-lg">${info.icon}</span>
            <span class="font-semibold">${item.org}</span>
            <span class="text-xs text-gray-500">${item.date}</span>
          </div>
          <h3 class="font-bold text-lg mb-2">${item.title}</h3>
          ${item.url ? `<a href="${item.url}" target="_blank" class="text-sm text-indigo-600 hover:underline mb-2 block">${item.url}</a>` : ''}
          ${item.bullets.length > 0 ? `
            <ul class="text-sm text-gray-600 dark:text-gray-300 space-y-1">
              ${item.bullets.map((b: any) => `
                <li class="${b.level > 1 ? 'ml-4 text-gray-500' : ''}">â€¢ ${b.text}</li>
              `).join('')}
            </ul>
          ` : ''}
        </div>
      `;
    }).join('');
  }

  // Event handlers
  document.getElementById('parse-btn')?.addEventListener('click', () => {
    const textarea = document.getElementById('markdown-input') as HTMLTextAreaElement;
    const year = (document.getElementById('input-year') as HTMLInputElement).value;
    const month = (document.getElementById('input-month') as HTMLInputElement).value;
    const week = (document.getElementById('input-week') as HTMLInputElement).value;

    const items = parseMarkdownItems(textarea.value, year, month, week);

    if (items.length === 0) {
      alert('íŒŒì‹±ëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤. í˜•ì‹ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
      return;
    }

    // Show preview
    document.getElementById('preview-section')?.classList.remove('hidden');
    renderPreview(items);

    // Generate JSON
    const jsonOutput = document.getElementById('json-output');
    if (jsonOutput) {
      jsonOutput.textContent = JSON.stringify(items, null, 2);
    }
  });

  document.getElementById('clear-btn')?.addEventListener('click', () => {
    (document.getElementById('markdown-input') as HTMLTextAreaElement).value = '';
    document.getElementById('preview-section')?.classList.add('hidden');
  });

  document.getElementById('copy-json')?.addEventListener('click', () => {
    const jsonOutput = document.getElementById('json-output');
    if (jsonOutput) {
      navigator.clipboard.writeText(jsonOutput.textContent || '');
      alert('JSONì´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
    }
  });
</script>
