---
interface Bullet {
  text: string;
  level: number;
}

interface Props {
  id: string;
  type: string;
  org: string;
  title: string;
  url: string;
  bullets: Bullet[];
  date: string;
  year?: string;
  month?: string;
  week?: string;
  tags?: string[];
  showWeek?: boolean;
}

const { id, type, org, title, url, bullets, date, year, month, week, tags = [], showWeek = false } = Astro.props;

const typeInfo: Record<string, { icon: string; label: string; color: string; bgLight: string; bgDark: string; accent: string }> = {
  paper: {
    icon: 'üìú',
    label: 'Paper',
    color: 'text-blue-700 dark:text-blue-300',
    bgLight: 'bg-blue-50 border-blue-100',
    bgDark: 'dark:bg-blue-950/20 dark:border-blue-900/30',
    accent: 'bg-blue-500',
  },
  dev: {
    icon: 'üßëüèª‚Äçüíª',
    label: 'Dev',
    color: 'text-emerald-700 dark:text-emerald-300',
    bgLight: 'bg-emerald-50 border-emerald-100',
    bgDark: 'dark:bg-emerald-950/20 dark:border-emerald-900/30',
    accent: 'bg-emerald-500',
  },
  news: {
    icon: 'üóûÔ∏è',
    label: 'News',
    color: 'text-violet-700 dark:text-violet-300',
    bgLight: 'bg-violet-50 border-violet-100',
    bgDark: 'dark:bg-violet-950/20 dark:border-violet-900/30',
    accent: 'bg-violet-500',
  },
};

const info = typeInfo[type] || typeInfo.paper;
const weekDisplay = week ? `W${week}` : '';
const dateDisplay = showWeek && year && month ? `${year}.${String(month).padStart(2, '0')} ${weekDisplay}` : '';
const hasMoreBullets = bullets.length > 3;
---

<article
  class={`item-card group relative rounded-xl border transition-all duration-200 hover:shadow-card-hover dark:hover:shadow-card-dark-hover ${info.bgLight} ${info.bgDark}`}
  data-type={type}
  data-org={org.toLowerCase()}
  data-title={title.toLowerCase()}
  data-id={id}
>
  <!-- Left accent bar -->
  <div class={`absolute top-0 left-0 w-1 h-full rounded-l-xl ${info.accent}`}></div>

  <div class="pl-4 pr-4 py-4">
    <!-- Header row -->
    <div class="flex items-center justify-between gap-2 mb-2.5">
      <div class="flex items-center gap-2 min-w-0">
        <span class={`inline-flex items-center gap-1 px-2 py-0.5 rounded-md text-xs font-semibold ${info.color} bg-white/60 dark:bg-white/5`}>
          {info.icon} {info.label}
        </span>
        <span class="text-sm font-medium text-sand-600 dark:text-sand-400 truncate">
          {org}
        </span>
      </div>
      <div class="flex items-center gap-1 flex-shrink-0">
        {dateDisplay && (
          <span class="text-xs text-sand-400 dark:text-sand-600 font-mono">
            {dateDisplay}
          </span>
        )}
      </div>
    </div>

    <!-- Title -->
    {url ? (
      <a
        href={url}
        target="_blank"
        rel="noopener noreferrer"
        class="block text-[15px] font-semibold text-sand-800 dark:text-sand-100 hover:text-claude-600 dark:hover:text-claude-400 transition-colors mb-2.5 leading-snug"
      >
        {title}
        <svg class="inline-block w-3.5 h-3.5 ml-1 opacity-0 group-hover:opacity-60 transition-opacity" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/></svg>
      </a>
    ) : (
      <h3 class="text-[15px] font-semibold text-sand-800 dark:text-sand-100 mb-2.5 leading-snug">
        {title}
      </h3>
    )}

    <!-- Bullets -->
    {bullets.length > 0 && (
      <div class="bullets-container">
        <ul class="space-y-1.5 text-sm text-sand-600 dark:text-sand-400 leading-relaxed">
          {bullets.slice(0, 3).map((bullet) => (
            <li class={`flex items-start gap-2 ${bullet.level > 1 ? 'ml-3 text-xs text-sand-500 dark:text-sand-500' : ''}`}>
              <span class={`mt-[7px] w-1 h-1 rounded-full flex-shrink-0 ${bullet.level > 1 ? 'bg-sand-400 dark:bg-sand-600' : info.accent}`}></span>
              <span>{bullet.text}</span>
            </li>
          ))}
        </ul>
        {hasMoreBullets && (
          <div class="bullets-extra hidden">
            <ul class="space-y-1.5 text-sm text-sand-600 dark:text-sand-400 leading-relaxed mt-1.5">
              {bullets.slice(3).map((bullet) => (
                <li class={`flex items-start gap-2 ${bullet.level > 1 ? 'ml-3 text-xs text-sand-500 dark:text-sand-500' : ''}`}>
                  <span class={`mt-[7px] w-1 h-1 rounded-full flex-shrink-0 ${bullet.level > 1 ? 'bg-sand-400 dark:bg-sand-600' : info.accent}`}></span>
                  <span>{bullet.text}</span>
                </li>
              ))}
            </ul>
          </div>
        )}
      </div>
    )}

    <!-- Action bar -->
    <div class="flex items-center justify-between mt-3 pt-2.5 border-t border-sand-200/50 dark:border-sand-800/30">
      <div class="flex items-center gap-1">
        {hasMoreBullets && (
          <button
            class="expand-btn text-xs text-sand-400 hover:text-claude-500 dark:text-sand-500 dark:hover:text-claude-400 transition-colors px-1.5 py-0.5 rounded"
            data-id={id}
          >
            +{bullets.length - 3}Í∞ú Îçî Î≥¥Í∏∞
          </button>
        )}
      </div>
      <div class="flex items-center gap-0.5">
        <!-- Bookmark button -->
        <button
          class="bookmark-btn p-1.5 rounded-md text-sand-300 hover:text-claude-500 dark:text-sand-600 dark:hover:text-claude-400 transition-colors"
          data-id={id}
          title="Î∂ÅÎßàÌÅ¨"
        >
          <svg class="w-4 h-4 bookmark-icon-empty" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"/></svg>
          <svg class="w-4 h-4 bookmark-icon-filled hidden" fill="currentColor" viewBox="0 0 24 24"><path d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"/></svg>
        </button>
        <!-- Share button -->
        <button
          class="share-btn p-1.5 rounded-md text-sand-300 hover:text-claude-500 dark:text-sand-600 dark:hover:text-claude-400 transition-colors"
          data-title={title}
          data-url={url}
          data-org={org}
          title="Í≥µÏú†"
        >
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/></svg>
        </button>
      </div>
    </div>

    <!-- Tags -->
    {tags.length > 0 && (
      <div class="flex flex-wrap gap-1.5 mt-2">
        {tags.map((tag) => (
          <span class="text-xs px-2 py-0.5 bg-sand-100 dark:bg-sand-800 text-sand-500 dark:text-sand-500 rounded-md">
            #{tag}
          </span>
        ))}
      </div>
    )}
  </div>
</article>

<script>
  // Expand/collapse bullets
  document.querySelectorAll('.expand-btn').forEach((btn) => {
    btn.addEventListener('click', () => {
      const card = btn.closest('.item-card');
      const extra = card?.querySelector('.bullets-extra');
      if (!extra) return;

      const isHidden = extra.classList.contains('hidden');
      extra.classList.toggle('hidden');
      btn.textContent = isHidden ? 'Ï†ëÍ∏∞' : `+${extra.querySelectorAll('li').length}Í∞ú Îçî Î≥¥Í∏∞`;
    });
  });

  // Bookmark functionality (localStorage)
  function getBookmarks(): string[] {
    try {
      return JSON.parse(localStorage.getItem('bookmarks') || '[]');
    } catch { return []; }
  }

  function saveBookmarks(ids: string[]) {
    localStorage.setItem('bookmarks', JSON.stringify(ids));
  }

  function updateBookmarkUI(btn: Element, isBookmarked: boolean) {
    const empty = btn.querySelector('.bookmark-icon-empty');
    const filled = btn.querySelector('.bookmark-icon-filled');
    if (isBookmarked) {
      empty?.classList.add('hidden');
      filled?.classList.remove('hidden');
      btn.classList.add('text-claude-500', 'dark:text-claude-400');
      btn.classList.remove('text-sand-300', 'dark:text-sand-600');
    } else {
      empty?.classList.remove('hidden');
      filled?.classList.add('hidden');
      btn.classList.remove('text-claude-500', 'dark:text-claude-400');
      btn.classList.add('text-sand-300', 'dark:text-sand-600');
    }
  }

  // Initialize bookmarks
  const bookmarks = getBookmarks();
  document.querySelectorAll('.bookmark-btn').forEach((btn) => {
    const id = (btn as HTMLElement).dataset.id || '';
    if (bookmarks.includes(id)) {
      updateBookmarkUI(btn, true);
    }

    btn.addEventListener('click', () => {
      const currentBookmarks = getBookmarks();
      const itemId = (btn as HTMLElement).dataset.id || '';
      const idx = currentBookmarks.indexOf(itemId);

      if (idx >= 0) {
        currentBookmarks.splice(idx, 1);
        updateBookmarkUI(btn, false);
        showToast('Î∂ÅÎßàÌÅ¨ÏóêÏÑú Ï†úÍ±∞ÎêòÏóàÏäµÎãàÎã§');
      } else {
        currentBookmarks.push(itemId);
        updateBookmarkUI(btn, true);
        showToast('Î∂ÅÎßàÌÅ¨Ïóê Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§');
      }
      saveBookmarks(currentBookmarks);
    });
  });

  // Share functionality
  document.querySelectorAll('.share-btn').forEach((btn) => {
    btn.addEventListener('click', () => {
      const el = btn as HTMLElement;
      const title = el.dataset.title || '';
      const url = el.dataset.url || '';
      const org = el.dataset.org || '';

      const text = `${title} (${org})`;

      if (navigator.share) {
        navigator.share({ title: text, url }).catch(() => {});
      } else {
        // Fallback: copy to clipboard
        navigator.clipboard.writeText(`${text}\n${url}`).then(() => {
          showToast('ÌÅ¥Î¶ΩÎ≥¥ÎìúÏóê Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§');
        });
      }
    });
  });

  // Toast helper
  function showToast(message: string) {
    const existing = document.querySelector('.toast');
    if (existing) existing.remove();

    const toast = document.createElement('div');
    toast.className = 'toast';
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
  }
</script>
